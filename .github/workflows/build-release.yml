name: Build and Release

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allows you to run this manually from the Actions tab

# MANUAL VERSIONING: Change this value to update your release version
env:
  APP_VERSION: "v2.0.0"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build executable
        run: |
          # Use ; as separator for Windows
          pyinstaller --onefile --windowed --name "Aurion" --icon "src/Icons/logo.ico" --add-data "src;src" --distpath "./dist" main.py
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aurion-windows
          path: dist/Aurion.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller Pillow
      
      - name: Convert icon to ICNS format
        run: |
          # Ensure this script exists in your repo
          python3 convert_icon_to_icns.py || echo "Icon conversion script not found, skipping..."
      
      - name: Build executable
        run: |
          # PyInstaller creates the .app bundle automatically with --windowed
          pyinstaller --onefile --windowed \
            --name "Aurion" \
            --icon "src/Icons/logo.icns" \
            --add-data "src:src" \
            --distpath "./dist" \
            main.py
      
      - name: Zip App Bundle
        # Zipping here preserves the "executable" permissions for macOS
        run: |
          cd dist
          zip -r ../Aurion-macos.zip Aurion.app
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aurion-macos
          path: Aurion-macos.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot dpkg-dev libfuse2 \
            libgstreamer1.0-0 gstreamer1.0-plugins-base gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly \
            gstreamer1.0-libav \
            libqt5multimedia5-plugins pkg-config imagemagick
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller Pillow
      
      - name: Build executable with PyInstaller
        run: |
          pyinstaller --onefile --windowed \
            --name "Aurion" \
            --icon "src/Icons/logo.ico" \
            --add-data "src:src" \
            --additional-hooks-dir=. \
            --collect-all gstreamer \
            --hidden-import=gstreamer \
            --distpath "./dist" \
            main.py
      
      - name: Create AppImage
        env:
          APPIMAGE_EXTRACT_AND_RUN: 1 # Fixes FUSE error on GitHub runners
        run: |
          mkdir -p AppDir/usr/bin
          cp dist/Aurion AppDir/usr/bin/
          
          # Simplified AppRun for the AppImage
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          APPDIR="$(dirname "$(readlink -f "$0")")"
          export LD_LIBRARY_PATH="$APPDIR/usr/lib:$LD_LIBRARY_PATH"
          exec "$APPDIR/usr/bin/Aurion" "$@"
          EOF
          chmod +x AppDir/AppRun
          
          cat > AppDir/Aurion.desktop << 'EOF'
          [Desktop Entry]
          Name=Aurion
          Exec=Aurion
          Icon=logo
          Type=Application
          Categories=AudioVideo;
          EOF
          
          cp src/Icons/logo.png AppDir/logo.png || touch AppDir/logo.png
          
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool
          ./appimagetool AppDir Aurion-${{ env.APP_VERSION }}-x86_64.AppImage
      
      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: aurion-linux-appimage
          path: Aurion-${{ env.APP_VERSION }}-x86_64.AppImage

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: Prepare Release Assets
        run: |
          mkdir -p release-assets
          cp artifacts/aurion-windows/Aurion.exe release-assets/Aurion-${{ env.APP_VERSION }}-windows.exe
          cp artifacts/aurion-macos/Aurion-macos.zip release-assets/Aurion-${{ env.APP_VERSION }}-macos.zip
          cp artifacts/aurion-linux-appimage/*.AppImage release-assets/
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.APP_VERSION }}
          name: Aurion v${{ env.APP_VERSION }}
          body: "Automated release build for Aurion Music Player"
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
