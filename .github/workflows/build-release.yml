name: Build and Release

on:
  push:
    branches:
      - main
      - master

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Calculate Version
        id: version
        run: |
          # Get the number of commits
          COMMIT_COUNT=$(git rev-list --count HEAD)
          # Convert to version: 1.0 for first commit, 1.1 for second, etc.
          MINOR=$((COMMIT_COUNT - 1))
          VERSION="1.$MINOR"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

  build-windows:
    needs: get-version
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build executable
        run: |
          pyinstaller --onefile --windowed --name "Aurion" --icon "src/Icons/logo.ico" --add-data "src:src" --distpath "./dist" main.py
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aurion-windows
          path: dist/Aurion.exe

  build-macos:
    needs: get-version
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller Pillow
      
      - name: Convert icon to ICNS format
        run: |
          python3 convert_icon_to_icns.py
      
      - name: Build executable
        run: |
          pyinstaller --onefile --windowed \
            --name "Aurion" \
            --icon "src/Icons/logo.icns" \
            --add-data "src:src" \
            --distpath "./dist" \
            main.py
      
      - name: Create app bundle
        run: |
          mkdir -p Aurion.app/Contents/MacOS
          mkdir -p Aurion.app/Contents/Resources
          mv dist/Aurion Aurion.app/Contents/MacOS/Aurion
          cp src/Icons/logo.icns Aurion.app/Contents/Resources/Aurion.icns
          cat > Aurion.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleName</key>
            <string>Aurion</string>
            <key>CFBundleDisplayName</key>
            <string>Aurion</string>
            <key>CFBundleExecutable</key>
            <string>Aurion</string>
            <key>CFBundleIconFile</key>
            <string>Aurion</string>
            <key>CFBundleIdentifier</key>
            <string>com.andrewdore.aurion</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleVersion</key>
            <string>1.0.0</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.13</string>
          </dict>
          </plist>
          EOF
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aurion-macos
          path: Aurion.app

  build-linux:
    needs: get-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot dpkg-dev libfuse2 \
            libgstreamer1.0-0 gstreamer1.0-plugins-base gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly \
            gstreamer1.0-libav \
            libqt5multimedia5-plugins pkg-config imagemagick
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller Pillow
      
      - name: Build executable with GStreamer bundling
        run: |
          pyinstaller --onefile --windowed \
            --name "Aurion" \
            --icon "src/Icons/logo.ico" \
            --add-data "src:src" \
            --additional-hooks-dir=. \
            --collect-all gstreamer \
            --hidden-import=gstreamer \
            --distpath "./dist" \
            main.py
      
      - name: Prepare AppImage directory structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/lib/gstreamer-1.0
          mkdir -p AppDir/usr/lib/x86_64-linux-gnu
          
          cp dist/Aurion AppDir/usr/bin/
          
          # Copy GStreamer libraries
          sudo cp -r /usr/lib/x86_64-linux-gnu/gstreamer-1.0/* AppDir/usr/lib/gstreamer-1.0/ 2>/dev/null || true
          sudo cp /usr/lib/x86_64-linux-gnu/libgstreamer-1.0.so* AppDir/usr/lib/ 2>/dev/null || true
          sudo cp /usr/lib/x86_64-linux-gnu/libgst*.so* AppDir/usr/lib/ 2>/dev/null || true
          
          # Fix permissions
          sudo chown -R $(id -u):$(id -g) AppDir/
          
          # Convert ico to png for AppImage
          if [ -f "src/Icons/logo.ico" ]; then
            convert src/Icons/logo.ico -background none AppDir/logo.png 2>/dev/null || \
            python3 << 'PYEOF'
from PIL import Image
img = Image.open("src/Icons/logo.ico")
if img.mode != "RGBA":
    img = img.convert("RGBA")
img.save("AppDir/logo.png", "PNG")
PYEOF
          fi
          
          # Ensure logo.png exists
          if [ ! -f "AppDir/logo.png" ] && [ -f "src/Icons/logo.png" ]; then
            cp src/Icons/logo.png AppDir/logo.png
          fi
          
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          APPDIR="$(dirname "$(readlink -f "$0")")"
          
          # Set up library paths for GStreamer and other system libraries
          export LD_LIBRARY_PATH="$APPDIR/usr/lib:$APPDIR/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"
          export GST_PLUGIN_SYSTEM_PATH="$APPDIR/usr/lib/gstreamer-1.0:/usr/lib/gstreamer-1.0:/usr/lib/x86_64-linux-gnu/gstreamer-1.0:$GST_PLUGIN_SYSTEM_PATH"
          export GST_PLUGIN_SCANNER="$APPDIR/usr/lib/gstreamer-1.0/gst-plugin-scanner"
          export GStreamer_FOUND=1
          
          # Run the application
          exec "$APPDIR/usr/bin/Aurion" "$@"
          EOF
          chmod +x AppDir/AppRun
          
          cat > AppDir/Aurion.desktop << 'EOF'
          [Desktop Entry]
          Name=Aurion
          Exec=Aurion
          Icon=logo
          Type=Application
          Categories=AudioVideo;Audio;Player;
          EOF
          
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool
          ./appimagetool AppDir Aurion-${{ needs.get-version.outputs.version }}-x86_64.AppImage
      
      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: aurion-linux-appimage
          path: Aurion-${{ needs.get-version.outputs.version }}-x86_64.AppImage

  create-release:
    needs: [get-version, build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: aurion-windows
          path: ./windows
      
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: aurion-macos
          path: ./macos
      
      - name: Download Linux AppImage artifact
        uses: actions/download-artifact@v4
        with:
          name: aurion-linux-appimage
          path: ./linux-appimage
      
      - name: Create macOS zip
        run: |
          mkdir -p release-assets
          # The artifact structure may vary, so we check what we got
          if [ -d "macos/Aurion.app" ]; then
            cd macos
            zip -r ../release-assets/Aurion-${{ needs.get-version.outputs.version }}-macos.zip Aurion.app
            cd ..
          elif [ -d "macos/Contents" ]; then
            # If the app structure was flattened, rebuild it
            mkdir -p macos-app/Aurion.app
            cp -r macos/* macos-app/Aurion.app/
            cd macos-app
            zip -r ../release-assets/Aurion-${{ needs.get-version.outputs.version }}-macos.zip Aurion.app
            cd ..
          else
            # List what we got for debugging
            echo "macOS artifact contents:"
            ls -la macos
            exit 1
          fi
      
      - name: Copy executables to release assets
        run: |
          mkdir -p release-assets
          cp windows/Aurion.exe release-assets/Aurion-${{ needs.get-version.outputs.version }}-windows.exe
          cp linux-appimage/Aurion-${{ needs.get-version.outputs.version }}-x86_64.AppImage release-assets/
      
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.get-version.outputs.version }}
          name: Aurion v${{ needs.get-version.outputs.version }}
          body: |
            Automated release build for Aurion Music Player
            
            **Downloads:**
            - **Windows**: `Aurion-${{ needs.get-version.outputs.version }}-windows.exe` - Direct executable
            - **macOS**: `Aurion-${{ needs.get-version.outputs.version }}-macos.zip` - App bundle
            - **Linux (AppImage)**: `Aurion-${{ needs.get-version.outputs.version }}-x86_64.AppImage` - Universal Linux executable
          files: release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
