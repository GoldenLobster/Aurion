name: Build and Release

on:
  push:
    branches:
      - main
      - master

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Calculate Version
        id: version
        run: |
          # Get the number of commits
          COMMIT_COUNT=$(git rev-list --count HEAD)
          # Convert to version: 1.0 for first commit, 1.1 for second, etc.
          MINOR=$((COMMIT_COUNT - 1))
          VERSION="1.$MINOR"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

  build-windows:
    needs: get-version
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build executable
        run: |
          pyinstaller --onefile --windowed --name "Aurion" --icon src/Icons/logo.ico --add-data "src:src" --distpath "./dist" main.py
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aurion-windows
          path: dist/Aurion.exe

  build-macos:
    needs: get-version
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build executable
        run: |
          pyinstaller --onefile --windowed \
            --name "Aurion" \
            --icon src/Icons/logo.ico \
            --add-data "src:src" \
            --distpath "./dist" \
            main.py
      
      - name: Create app bundle
        run: |
          mkdir -p Aurion.app/Contents/MacOS
          mkdir -p Aurion.app/Contents/Resources
          mv dist/Aurion Aurion.app/Contents/MacOS/Aurion
          cp src/Icons/logo.icns Aurion.app/Contents/Resources/ 2>/dev/null || true
          cat > Aurion.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleName</key>
            <string>Aurion</string>
            <key>CFBundleExecutable</key>
            <string>Aurion</string>
            <key>CFBundleIconFile</key>
            <string>logo</string>
          </dict>
          </plist>
          EOF
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aurion-macos
          path: Aurion.app

  build-linux:
    needs: get-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot dpkg-dev libfuse2 \
            libgstreamer1.0-0 gstreamer1.0-plugins-base gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly \
            gstreamer1.0-libav \
            libgstgl-1.0-0 libgstallocators-1.0-0 \
            libqt5multimedia5-plugins pkg-config
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build executable with GStreamer bundling
        run: |
          pyinstaller --onefile --windowed \
            --name "Aurion" \
            --icon src/Icons/logo.ico \
            --add-data "src:src" \
            --additional-hooks-dir=. \
            --collect-all gstreamer \
            --hidden-import=gstreamer \
            --distpath "./dist" \
            main.py
      
      - name: Prepare AppImage directory structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/lib/gstreamer-1.0
          mkdir -p AppDir/usr/lib/x86_64-linux-gnu
          
          cp dist/Aurion AppDir/usr/bin/
          
          # Copy GStreamer libraries
          sudo cp -r /usr/lib/x86_64-linux-gnu/gstreamer-1.0/* AppDir/usr/lib/gstreamer-1.0/ 2>/dev/null || true
          sudo cp /usr/lib/x86_64-linux-gnu/libgstreamer-1.0.so* AppDir/usr/lib/ 2>/dev/null || true
          sudo cp /usr/lib/x86_64-linux-gnu/libgst*.so* AppDir/usr/lib/ 2>/dev/null || true
          
          # Fix permissions
          sudo chown -R $(id -u):$(id -g) AppDir/
          
          # Create a simple PNG logo for AppImage (convert from ico if needed)
          if [ -f "src/Icons/logo.png" ]; then
            cp src/Icons/logo.png AppDir/logo.png
          else
            # Convert ico to png using ImageMagick if available, otherwise use a placeholder
            if command -v convert &> /dev/null; then
              convert src/Icons/logo.ico AppDir/logo.png
            else
              # Create a minimal PNG if conversion fails
              python3 << 'PYEOF'
          import os
          # Create a minimal valid PNG file if no icon available
          # This is a 1x1 transparent pixel PNG (minimal valid PNG)
          png_bytes = bytes([
              0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A, 0x00, 0x00, 0x00, 0x0D,
              0x49, 0x48, 0x44, 0x52, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
              0x08, 0x06, 0x00, 0x00, 0x00, 0x1F, 0x15, 0xC4, 0x89, 0x00, 0x00, 0x00,
              0x0A, 0x49, 0x44, 0x41, 0x54, 0x78, 0x9C, 0x63, 0x00, 0x01, 0x00, 0x00,
              0x05, 0x00, 0x01, 0x0D, 0x0A, 0x2D, 0xB4, 0x00, 0x00, 0x00, 0x00, 0x49,
              0x45, 0x4E, 0x44, 0xAE, 0x42, 0x60, 0x82
          ])
          with open("AppDir/logo.png", "wb") as f:
              f.write(png_bytes)
          PYEOF
            fi
          fi
          
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          APPDIR="$(dirname "$(readlink -f "$0")")"
          
          # Set up library paths for GStreamer and other system libraries
          export LD_LIBRARY_PATH="$APPDIR/usr/lib:$APPDIR/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"
          export GST_PLUGIN_SYSTEM_PATH="$APPDIR/usr/lib/gstreamer-1.0:/usr/lib/gstreamer-1.0:/usr/lib/x86_64-linux-gnu/gstreamer-1.0:$GST_PLUGIN_SYSTEM_PATH"
          export GST_PLUGIN_SCANNER="$APPDIR/usr/lib/gstreamer-1.0/gst-plugin-scanner"
          export GStreamer_FOUND=1
          
          # Run the application
          exec "$APPDIR/usr/bin/Aurion" "$@"
          EOF
          chmod +x AppDir/AppRun
          
          cat > AppDir/Aurion.desktop << 'EOF'
          [Desktop Entry]
          Name=Aurion
          Exec=Aurion
          Icon=logo
          Type=Application
          Categories=AudioVideo;Audio;Player;
          EOF
          
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool
          ./appimagetool AppDir Aurion-${{ needs.get-version.outputs.version }}-x86_64.AppImage
      
      - name: Create Debian Package
        run: |
          mkdir -p debian-build/DEBIAN
          mkdir -p debian-build/usr/bin
          mkdir -p debian-build/usr/share/applications
          mkdir -p debian-build/usr/share/icons
          
          cp dist/Aurion debian-build/usr/bin/
          chmod +x debian-build/usr/bin/Aurion
          
          cp src/Icons/logo.png debian-build/usr/share/icons/ 2>/dev/null || true
          
          cat > debian-build/usr/share/applications/aurion.desktop << 'EOF'
          [Desktop Entry]
          Name=Aurion
          Exec=/usr/bin/Aurion
          Icon=logo
          Type=Application
          Categories=AudioVideo;Audio;Player;
          EOF
          
          cat > debian-build/DEBIAN/control << 'EOF'
          Package: aurion
          Version: ${{ needs.get-version.outputs.version }}
          Architecture: amd64
          Maintainer: Aurion <aurion@example.com>
          Description: A sleek, feature-rich music player for Linux, Windows, and macOS
          Depends: libc6, libqt5gui5, libqt5core5a, libgstreamer1.0-0, gstreamer1.0-plugins-base, gstreamer1.0-plugins-good
          EOF
          
          dpkg-deb --build debian-build aurion_${{ needs.get-version.outputs.version }}_amd64.deb
      
      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: aurion-linux-appimage
          path: Aurion-${{ needs.get-version.outputs.version }}-x86_64.AppImage
      
      - name: Upload Debian artifact
        uses: actions/upload-artifact@v4
        with:
          name: aurion-linux-debian
          path: aurion_${{ needs.get-version.outputs.version }}_amd64.deb

  create-release:
    needs: [get-version, build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: aurion-windows
          path: ./windows
      
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: aurion-macos
          path: ./macos
      
      - name: Download Linux AppImage artifact
        uses: actions/download-artifact@v4
        with:
          name: aurion-linux-appimage
          path: ./linux-appimage
      
      - name: Download Linux Debian artifact
        uses: actions/download-artifact@v4
        with:
          name: aurion-linux-debian
          path: ./linux-debian
      
      - name: Create macOS zip
        run: |
          mkdir -p release-assets
          # The artifact structure may vary, so we check what we got
          if [ -d "macos/Aurion.app" ]; then
            cd macos
            zip -r ../release-assets/Aurion-${{ needs.get-version.outputs.version }}-macos.zip Aurion.app
            cd ..
          elif [ -d "macos/Contents" ]; then
            # If the app structure was flattened, rebuild it
            mkdir -p macos-app/Aurion.app
            cp -r macos/* macos-app/Aurion.app/
            cd macos-app
            zip -r ../release-assets/Aurion-${{ needs.get-version.outputs.version }}-macos.zip Aurion.app
            cd ..
          else
            # List what we got for debugging
            echo "macOS artifact contents:"
            ls -la macos
            exit 1
          fi
      
      - name: Copy executables to release assets
        run: |
          mkdir -p release-assets
          cp windows/Aurion.exe release-assets/Aurion-${{ needs.get-version.outputs.version }}-windows.exe
          cp linux-appimage/Aurion-${{ needs.get-version.outputs.version }}-x86_64.AppImage release-assets/
          cp linux-debian/*.deb release-assets/
      
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.get-version.outputs.version }}
          name: Aurion v${{ needs.get-version.outputs.version }}
          body: |
            Automated release build for Aurion Music Player
            
            **Downloads:**
            - **Windows**: `Aurion-${{ needs.get-version.outputs.version }}-windows.exe` - Direct executable
            - **macOS**: `Aurion-${{ needs.get-version.outputs.version }}-macos.zip` - App bundle
            - **Linux (AppImage)**: `Aurion-${{ needs.get-version.outputs.version }}-x86_64.AppImage` - Universal Linux executable
            - **Linux (Debian)**: `aurion_${{ needs.get-version.outputs.version }}_amd64.deb` - Debian/Ubuntu package
          files: release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
